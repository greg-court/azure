name: 'APIM Terraform CI'

on:
  pull_request:
    paths:
      - 'apim/**'
      - 'terraform.tfvars'
      - 'terraform.tfbackend'
      - '.github/workflows/apim-ci.yaml'
    branches:
      - main

permissions:
  id-token: write      # Required for OIDC login in reusable workflow
  contents: read       # Required for checkout
  pull-requests: write # Required for PR commenting in reusable workflow

jobs:
  terraform_ci:
    name: 'Terraform CI (APIM - Dev Env)'
    uses: greg-court/cicd-templates/.github/workflows/terraform-ci.yaml@main
    with:
      working_directory: 'apim'
      tfvars_paths: '["../shared.tfvars", "environments/dev.tfvars"]'
      terraform_backend_key: 'apim.tfstate'
      environment_name: 'dev-plan'
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      BACKEND_SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID_MANAGEMENT }}
      BACKEND_RESOURCE_GROUP_NAME: ${{ secrets.BACKEND_RESOURCE_GROUP_NAME }}
      BACKEND_STORAGE_ACCOUNT_NAME: ${{ secrets.BACKEND_STORAGE_ACCOUNT_NAME}}
      BACKEND_STORAGE_CONTAINER_NAME: ${{ secrets.BACKEND_STORAGE_CONTAINER_NAME }}
